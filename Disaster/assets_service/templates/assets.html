<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Asset Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f7fa; }
        
        .top-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 30px;
        }
        
        .top-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #667eea;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }
        
        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
        }
        
        .home-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .home-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .header { background: #fff; padding: 20px 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; font-weight: 700; color: #1a1a1a; }
        .add-btn { background: #1e88e5; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .add-btn:hover { background: #1565c0; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }
        
        .kpi-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .kpi-label { font-size: 14px; color: #666; margin-bottom: 10px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #1a1a1a; }
        
        .dashboard-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 30px; }
        .dashboard-card { border-radius: 16px; padding: 40px; position: relative; overflow: hidden; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .dashboard-card.demand { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dashboard-card.supply { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .dashboard-card.video { background: linear-gradient(135deg, #fbc531 0%, #f39c12 100%); }
        .empty-cards-message { grid-column: 1 / -1; text-align: center; padding: 60px; background: white; border-radius: 16px; color: #666; }
        .empty-cards-message p { font-size: 18px; margin-bottom: 20px; }
        .dashboard-number { font-size: 64px; font-weight: 700; margin-bottom: 15px; opacity: 0.9; }
        .dashboard-title { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        .dashboard-desc { font-size: 14px; opacity: 0.9; margin-bottom: 20px; }
        .dashboard-link { color: white; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .dashboard-icon { position: absolute; top: 20px; right: 20px; font-size: 48px; opacity: 0.3; }
        
        .graph-section { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .graph-title { font-size: 20px; font-weight: 600; color: #1a1a1a; margin-bottom: 20px; }
        .graph-container { height: 400px; position: relative; }
        
        .assets-table { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .table-title { font-size: 20px; font-weight: 600; color: #1a1a1a; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #e0e0e0; color: #666; font-weight: 600; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .status-online { color: #4caf50; font-weight: 600; }
        .asset-link { color: #1e88e5; text-decoration: none; font-weight: 600; }
        .asset-actions { display: flex; gap: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #666; }
        .action-btn:hover { color: #1e88e5; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; border-radius: 16px; padding: 40px; max-width: 500px; margin: 50px auto; position: relative; }
        .modal-header { margin-bottom: 30px; }
        .modal-header h2 { color: #1e88e5; font-size: 1.8em; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; color: #333; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .form-buttons { display: flex; gap: 10px; margin-top: 30px; }
        .btn-primary { background: #1e88e5; color: white; padding: 14px 28px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; flex: 1; }
        .btn-secondary { background: #e0e0e0; color: #333; padding: 14px 28px; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; flex: 1; }
    </style>
</head>
<body>
    <nav class="top-header">
        <div class="top-header-content">
            <a href="/eop" class="logo">
                <span class="logo-icon">‚ö°</span>
                <span>Energy Orchestrator Platform</span>
            </a>
            <div class="nav-menu">
                <a href="/eop" class="nav-link home-link">Ìôà</a>
                <a href="/da" class="nav-link">Energy Demand</a>
                <a href="/sa" class="nav-link">Energy Supply</a>
                <a href="/assets" class="nav-link">Asset Management</a>
                <a href="/dashboard" class="nav-link">Disaster</a>
            </div>
        </div>
    </nav>
    <div class="header">
        <h1>Energy Asset Management</h1>
        <button class="add-btn" onclick="openModal()">+ Add Asset</button>
    </div>
    
    <div class="container">
        <!-- KPI Cards -->
        <div class="kpi-cards">
            <div class="kpi-card">
                <div class="kpi-label">Total Assets</div>
                <div class="kpi-value" id="totalAssets">{{ assets|length }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Operating</div>
                <div class="kpi-value" id="operating">{{ assets|length }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Capacity</div>
                <div class="kpi-value" id="totalCapacity">0.0 kW</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Avg Capacity</div>
                <div class="kpi-value" id="avgCapacity">0.0 kW</div>
            </div>
        </div>
        
        <!-- Dashboard Cards (Dynamically Generated from Assets) -->
        <div class="dashboard-cards" id="dashboardCards">
            {% set has_dashboard_cards = false %}
            {% for asset in assets %}
            {% if asset.type == 'demand' or asset.type == 'supply' %}
            {% set has_dashboard_cards = true %}
            <div class="dashboard-card {{ asset.type }}" onclick="openDashboard('{{ asset.service_url }}', '{{ asset.name }}')">
                <div class="dashboard-number">{{ asset.id }}</div>
                <div class="dashboard-title">{{ asset.name }}</div>
                <div class="dashboard-desc">
                    {% if asset.type == 'demand' %}
                        Real-time monitoring ‚Ä¢ Smart matching ‚Ä¢ Data analysis
                    {% elif asset.type == 'supply' %}
                        Solar power ‚Ä¢ Real-time monitoring ‚Ä¢ AI-based matching
                    {% endif %}
                </div>
                <a href="{{ asset.service_url }}?asset={{ asset.name }}" class="dashboard-link" onclick="event.stopPropagation();">Open ‚Üó</a>
                <div class="dashboard-icon">
                    {% if asset.type == 'demand' %}
                        üìä
                    {% elif asset.type == 'supply' %}
                        ‚ö°
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% if not has_dashboard_cards %}
            <div class="empty-cards-message">
                <p>No dashboard cards available. Add assets with type "Demand" or "Supply" to see dashboard cards here.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Energy Supply & Demand Matching Graph -->
        <div class="graph-section">
            <div class="graph-title">Energy Supply & Demand Matching (15-minute intervals)</div>
            <div class="graph-container">
                <canvas id="energyChart"></canvas>
            </div>
        </div>
        
        <!-- Assets Table -->
        <div class="assets-table">
            <div class="table-title">Asset List</div>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Capacity (kW)</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="assetsTableBody">
                    {% for asset in assets %}
                    <tr>
                        <td>
                            {% if asset.type == 'demand' %}
                                üè¢ Building
                            {% elif asset.type == 'supply' %}
                                ‚òÄÔ∏è Solar Panel
                            {% else %}
                                üì° Other
                            {% endif %}
                        </td>
                        <td><a href="{{ asset.service_url }}" class="asset-link" target="_blank">{{ asset.name }}</a></td>
                        <td>-</td>
                        <td><span class="status-online">online</span></td>
                        <td>{{ asset.created_at[:10] if asset.created_at else '2025. 11. 3.' }}</td>
                        <td>
                            <div class="asset-actions">
                                <button class="action-btn" onclick="editAsset({{ asset.id }})">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="deleteAsset({{ asset.id }})">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add Asset Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Asset</h2>
            </div>
            <form id="assetForm">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="type">Type</label>
                    <select id="type" name="type" required>
                        <option value="">Select</option>
                        <option value="demand">Demand</option>
                        <option value="supply">Supply</option>
                        <option value="video">Image</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="api_url">API URL</label>
                    <input type="text" id="api_url" name="api_url" placeholder="https://api.example.com" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn-primary">Add</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Initialize Chart
        const ctx = document.getElementById('energyChart').getContext('2d');
        const energyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => String(i).padStart(2, '0') + ':00'),
                datasets: [
                    {
                        label: 'Energy Demand (kW)',
                        data: [50, 55, 60, 70, 85, 100, 120, 140, 160, 170, 175, 170, 165, 160, 155, 145, 135, 125, 115, 100, 85, 70, 60, 55],
                        borderColor: '#1e88e5',
                        backgroundColor: 'rgba(30, 136, 229, 0.1)',
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Energy Supply (kW)',
                        data: [0, 0, 0, 10, 30, 60, 90, 120, 150, 180, 185, 180, 175, 170, 160, 140, 100, 50, 20, 5, 0, 0, 0, 0],
                        borderColor: '#e53935',
                        backgroundColor: 'rgba(229, 57, 53, 0.1)',
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 200,
                        ticks: {
                            stepSize: 20
                        },
                        title: {
                            display: true,
                            text: 'Power (kW)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                }
            }
        });
        
        function openModal() {
            document.getElementById('addModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('assetForm').reset();
        }
        
        // Open dashboard in new window
        function openDashboard(serviceUrl, assetName) {
            // If serviceUrl is relative, ensure it starts with /
            if (serviceUrl && !serviceUrl.startsWith('http')) {
                if (!serviceUrl.startsWith('/')) {
                    serviceUrl = '/' + serviceUrl;
                }
                // Add asset name as URL parameter
                if (assetName) {
                    const separator = serviceUrl.includes('?') ? '&' : '?';
                    serviceUrl = serviceUrl + separator + 'asset=' + encodeURIComponent(assetName);
                }
                // Ensure it goes to agent.gngmeta.com
                window.location.href = serviceUrl;
            } else if (serviceUrl) {
                if (assetName) {
                    const separator = serviceUrl.includes('?') ? '&' : '?';
                    serviceUrl = serviceUrl + separator + 'asset=' + encodeURIComponent(assetName);
                }
                window.open(serviceUrl, '_blank');
            }
        }
        
        // Get base path for API calls
        const getBasePath = () => {
            const path = window.location.pathname;
            // If accessed through /assets/, use /assets as base path
            if (path.startsWith('/assets')) {
                return '/assets';
            }
            return '';
        };
        
        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                type: formData.get('type'),
                api_url: formData.get('api_url')
            };
            
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/assets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    closeModal();
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + (error.message || 'Unknown error'));
            }
        });
        
        async function deleteAsset(assetId) {
            if (!confirm('Are you sure you want to delete this asset?')) return;
            
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/assets/${assetId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + (error.message || 'Unknown error'));
            }
        }
        
        function editAsset(assetId) {
            // Edit functionality can be added here
            alert('Edit functionality coming soon');
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>





